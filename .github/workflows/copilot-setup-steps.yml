name: "Copilot Setup Steps"

# This workflow configures the environment for GitHub Copilot coding agent
# It installs the necessary tools for modernizing COBOL applications to Node.js
# Reference: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/customize-the-agent-environment

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # This job name MUST be 'copilot-setup-steps' for Copilot to recognize it
  copilot-setup-steps:
    runs-on: ubuntu-latest
    
    # Use minimal permissions for security
    permissions:
      contents: read
    
    timeout-minutes: 10
    
    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Set up Node.js for the modernized application
      # Node.js is required for running and testing the converted Node.js code
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      
      # Step 3: Install GnuCOBOL compiler
      # GnuCOBOL is needed to compile and verify legacy COBOL applications
      # This allows the agent to compile COBOL files before modernization
      - name: Install GnuCOBOL compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y gnucobol
          cobc --version
      
      # Step 4: Install Node.js dependencies if package.json exists
      # This ensures all npm packages are available for the Node.js application
      - name: Install Node.js dependencies
        run: |
          if [ -f "package.json" ]; then
            npm ci
          elif [ -d "node-accounting-app" ] && [ -f "node-accounting-app/package.json" ]; then
            cd node-accounting-app
            npm ci
          else
            echo "No package.json found - skipping npm install"
          fi
        continue-on-error: true
      
      # Step 5: Verify installations
      - name: Verify tool installations
        run: |
          echo "=== Checking installed tools ==="
          echo "Node.js version:"
          node --version
          echo "npm version:"
          npm --version
          echo "GnuCOBOL version:"
          cobc --version
          echo "=== All tools installed successfully ==="
