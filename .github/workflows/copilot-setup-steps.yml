name: "Copilot Setup Steps"

# This workflow configures the environment for GitHub Copilot coding agent
# It installs the necessary tools for modernizing COBOL applications to Node.js
# Reference: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/customize-the-agent-environment

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # This job name MUST be 'copilot-setup-steps' for Copilot to recognize it
  copilot-setup-steps:
    runs-on: ubuntu-latest
    
    # Use minimal permissions for security
    permissions:
      contents: read
    
    timeout-minutes: 10
    
    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Set up Node.js for the modernized application
      # Node.js is required for running and testing the converted Node.js code
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # Step 3: Install GnuCOBOL compiler
      # GnuCOBOL is needed to compile and verify legacy COBOL applications
      # This allows the agent to compile COBOL files before modernization
      - name: Install GnuCOBOL compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y gnucobol
          cobc --version
      
      # Step 4: Install Node.js dependencies if package.json exists
      # This ensures all npm packages are available for the Node.js application
      # Searches for package.json files in common locations
      - name: Install Node.js dependencies
        run: |
          # Function to install dependencies in a directory
          install_deps() {
            local dir=$1
            echo "Installing dependencies in $dir"
            (
              cd "$dir" || exit 1
              if [ -f "package-lock.json" ]; then
                echo "Found package-lock.json, using npm ci"
                npm ci
              else
                echo "No package-lock.json found, using npm install"
                npm install
              fi
            )
            local status=$?
            if [ $status -ne 0 ]; then
              echo "WARNING: Failed to install dependencies in $dir (exit code: $status)"
              return 1
            fi
            return 0
          }
          
          found_package=false
          
          # Check root directory first
          if [ -f "package.json" ]; then
            install_deps "." && found_package=true
          fi
          
          # Enable nullglob to handle no matches gracefully
          shopt -s nullglob
          
          # Check for Node.js project directories
          for dir in node-* */node-* nodejs-* */nodejs-*; do
            if [ -d "$dir" ] && [ -f "$dir/package.json" ]; then
              install_deps "$dir" && found_package=true
            fi
          done
          
          # Disable nullglob
          shopt -u nullglob
          
          if [ "$found_package" = false ]; then
            echo "No package.json found - skipping npm install"
          fi
        continue-on-error: true
      
      # Step 5: Verify installations
      - name: Verify tool installations
        run: |
          echo "=== Checking installed tools ==="
          echo "Node.js version:"
          node --version
          echo "npm version:"
          npm --version
          echo "GnuCOBOL version:"
          cobc --version
          echo "=== All tools installed successfully ==="
